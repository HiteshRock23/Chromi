{% extends 'base.html' %}
{% load static %}

{% block title %}Chromi - Make Your Desktop Come Alive{% endblock %}

{% block content %}
    <!-- Fullscreen background video -->
    <div class="bg-video-wrap" aria-hidden="true">
        <video class="bg-video" autoplay muted loop playsinline preload="auto">
            <source src="{% static 'videos/bg.mp4' %}" type="video/mp4">
            <!-- Add additional formats (webm) if you provide them -->
        </video>
        <div class="video-dim"></div>
    </div>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">C</div>
                <h1>Chromi</h1>
            </div>
            <p class="tagline">Make Your Desktop Come Alive</p>
        </header>

        <main class="main-content">
            <div class="converter-card">
                <div id="drop-area" class="drop-area">
                    <div class="drop-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                            <path d="M19 15L20.5 16.5L22 15L20.5 13.5L19 15Z" fill="currentColor"/>
                            <path d="M5 15L6.5 16.5L8 15L6.5 13.5L5 15Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <h3>Drop your video here</h3>
                    <p>or</p>
                    <label for="videoInput" class="file-input-label">
                        <span>Choose a file</span>
                    </label>
                    <input type="file" id="videoInput" accept="video/*" hidden>
                    <p class="file-types">Supported formats: MP4, MOV ‚Üí Chrome background</p>
                </div>

                <div id="video-preview-container" class="video-preview-container hidden">
                    <div class="video-wrapper">
                        <video id="video-preview" controls></video>
                        <div class="video-overlay">
                            <div class="file-info">
                                <span class="file-icon">üìπ</span>
                                <span id="file-name" class="file-name"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trim-controls">
                        <h3>Trim Your Video</h3>
                        <div class="trim-input-group">
                            <label for="start-time-slider">
                                <span class="label-text">Start Time</span>
                                <span id="start-time-value" class="time-value">0:00</span>
                            </label>
                            <input type="range" id="start-time-slider" min="0" max="100" value="0" step="1" class="range-slider">
                        </div>
                        
                        <div class="trim-input-group">
                            <label for="duration-slider">
                                <span class="label-text">Duration (3-10 seconds)</span>
                                <span id="duration-value" class="time-value">5 seconds</span>
                            </label>
                            <input type="range" id="duration-slider" min="3" max="10" value="5" step="1" class="range-slider">
                        </div>
                        
                        <button id="preview-trim-btn" class="btn btn-secondary">
                            <span class="btn-icon">üëÅÔ∏è</span>
                            Preview Trimmed Clip
                        </button>
                    </div>
                    
                    <button id="convert-btn" class="btn btn-primary">
                        <span class="btn-icon">‚ú®</span>
                        Convert to Chrome Background
                    </button>
                </div>

                <div id="conversion-status" class="conversion-status hidden">
                    <div class="loader-container">
                        <div class="loader"></div>
                        <div class="loader-text">Converting your video...</div>
                    </div>
                </div>

                <div id="download-container" class="download-container hidden">
                    <div class="success-icon">‚úÖ</div>
                    <h3>Conversion Complete!</h3>
                    <p>Your Chrome background is ready to download</p>
                    <div class="download-actions">
                        <button id="download-btn" class="btn btn-primary">
                            <span class="btn-icon">‚¨áÔ∏è</span>
                            Download Chrome Background
                        </button>
                        <button id="new-conversion-btn" class="btn btn-secondary">
                            <span class="btn-icon">üîÑ</span>
                            Convert Another Video
                        </button>
                    </div>
                </div>

                <div id="error-container" class="error-container hidden">
                    <div class="error-icon">‚ùå</div>
                    <h3>Oops! Something went wrong</h3>
                    <p id="error-message" class="error-message"></p>
                    <button id="error-retry-btn" class="btn btn-secondary">
                        <span class="btn-icon">üîÑ</span>
                        Try Again
                    </button>
                </div>
                {% csrf_token %}
            </div>
        </main>

        <footer class="footer">
            <div class="footer-content">
                <p>Upload limit: 100MB | No login required | Your files are not stored permanently</p>
                <div class="creator-info">
                    <p class="creator-name">Build with ‚ô° by Student for Students. </p>
                    <p class="creator-tagline">When Code meets Creativity and Xplodes</p>
                </div>

                <!-- Social media footer (centered icons) -->
                <div class="social-footer" aria-label="Social links">
                    <ul class="social-links">
                        <li>
                            <a href="https://github.com/HiteshRock23" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                                <i class="fab fa-github" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.linkedin.com/in/hitesh-r-04b20b354/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn">
                                <i class="fab fa-linkedin" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://x.com/Hitesh_Rock23" target="_blank" rel="noopener noreferrer" aria-label="X">
                                <i class="fab fa-twitter" aria-hidden="true"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </footer>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('videoInput');
            const videoPreviewContainer = document.getElementById('video-preview-container');
            const videoPreview = document.getElementById('video-preview');
            const fileName = document.getElementById('file-name');
            const convertBtn = document.getElementById('convert-btn');
            const conversionStatus = document.getElementById('conversion-status');
            const downloadContainer = document.getElementById('download-container');
            const downloadBtn = document.getElementById('download-btn');
            const newConversionBtn = document.getElementById('new-conversion-btn');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const errorRetryBtn = document.getElementById('error-retry-btn');
            
            // Trim controls
            const startTimeSlider = document.getElementById('start-time-slider');
            const startTimeValue = document.getElementById('start-time-value');
            const durationSlider = document.getElementById('duration-slider');
            const durationValue = document.getElementById('duration-value');
            const previewTrimBtn = document.getElementById('preview-trim-btn');

            // CSRF token - Safe access
            const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';
            
            // Current file and trim settings
            let currentFile = null;
            let convertedFileUrl = null;
            let startTime = "00:00:00";
            let duration = 5; // Default duration in seconds
            let isTrimPreview = false;
            let originalVideoTime = 0;
            let trimPreviewTimeout = null;

            // Defensive check: If essential elements are missing, stop execution to prevent errors
            if (!dropArea || !fileInput || !videoPreview || !convertBtn) {
                console.warn('Essential DOM elements for video converter not found. Script execution stopped.');
                return;
            }

            // Ensure file input has correct attributes even if HTML is malformed
            if (fileInput) {
                if (!fileInput.getAttribute('accept')) {
                    fileInput.setAttribute('accept', 'video/*');
                }
            }

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            // Handle dropped files
            dropArea.addEventListener('drop', handleDrop, false);
            
            // Handle file input change
            if (fileInput) {
                fileInput.addEventListener('change', handleFiles, false);
            }
            
            // Handle convert button click
            if (convertBtn) {
                convertBtn.addEventListener('click', convertVideo, false);
            }
            
            // Handle download button click
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadConvertedVideo, false);
            }
            
            // Handle new conversion button click
            if (newConversionBtn) {
                newConversionBtn.addEventListener('click', resetConverter, false);
            }
            
            // Handle error retry button click
            if (errorRetryBtn) {
                errorRetryBtn.addEventListener('click', resetConverter, false);
            }
            
            // Handle start time slider change
            if (startTimeSlider) {
                startTimeSlider.addEventListener('input', updateStartTimeValue, false);
            }
            
            // Handle duration slider change
            if (durationSlider) {
                durationSlider.addEventListener('input', updateDurationValue, false);
            }
            
            // Handle preview trim button click
            if (previewTrimBtn) {
                previewTrimBtn.addEventListener('click', previewTrimmedClip, false);
            }
            
            // Initialize video metadata
            if (videoPreview) {
                videoPreview.addEventListener('loadedmetadata', initializeVideoControls, false);
                 // Handle video end event to reset preview
                videoPreview.addEventListener('ended', function() {
                    if (isTrimPreview) {
                        isTrimPreview = false;
                    }
                });
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                if (dropArea) dropArea.classList.add('highlight');
            }

            function unhighlight() {
                if (dropArea) dropArea.classList.remove('highlight');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles({ target: { files: files } });
            }

            function handleFiles(e) {
                const files = e.target.files; // Accesses .files correctly
                if (files && files.length) {
                    const file = files[0];
                    console.log("File selected:", file.name, "Type:", file.type, "Size:", file.size);

                    // Check file type (MIME type OR extension)
                    const fileType = file.type;
                    const fileNameFn = file.name.toLowerCase();
                    const validExtensions = ['.mp4', '.mov'];
                    const isValidExtension = validExtensions.some(ext => fileNameFn.endsWith(ext));
                    
                    // Relaxed validation: Accept if MIME type matches OR extension matches
                    if ((fileType !== 'video/mp4' && fileType !== 'video/quicktime') && !isValidExtension) {
                        console.error("Invalid file type:", fileType, "Extension valid:", isValidExtension);
                        showError('Please upload an MP4 or MOV video file.');
                        return;
                    }
                    
                    // Check file size (100MB limit)
                    if (file.size > 100 * 1024 * 1024) {
                        console.error("File too large:", file.size);
                        showError('File size exceeds 100MB limit.');
                        return;
                    }
                    
                    currentFile = file;
                    try {
                        displayVideoPreview(file);
                    } catch (e) {
                         console.error("Error displaying preview:", e);
                         showError("Could not display video preview. Please try another file.");
                    }
                }
            }

            function displayVideoPreview(file) {
                 if (!videoPreview || !fileName || !dropArea || !videoPreviewContainer || !errorContainer) return;

                // Create object URL for the file
                const objectUrl = URL.createObjectURL(file);
                
                // Set video source and display preview
                videoPreview.src = objectUrl;
                fileName.textContent = file.name;
                
                // Show preview container, hide drop area
                dropArea.classList.add('hidden');
                videoPreviewContainer.classList.remove('hidden');
                errorContainer.classList.add('hidden');
            }

            function convertVideo() {
                if (!currentFile) return;
                
                if (!videoPreviewContainer || !conversionStatus) return;

                // Show conversion status
                videoPreviewContainer.classList.add('hidden');
                conversionStatus.classList.remove('hidden');
                
                // Create form data
                const formData = new FormData();
                formData.append('video', currentFile);
                if (csrfToken) {
                    formData.append('csrfmiddlewaretoken', csrfToken);
                } else {
                    console.error("CSRF token missing");
                    showError("Security token missing. Please refresh the page.");
                    return;
                }
                
                // Add trim parameters
                formData.append('start_time', startTime);
                formData.append('duration', duration);
                
                // Send request to server
                fetch('/convert/', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        convertedFileUrl = data.converted_url;
                        showDownloadOptions();
                    } else {
                        showError(data.error || 'An error occurred during conversion.');
                    }
                })
                .catch(error => {
                    showError('An error occurred during conversion. Please try again.');
                    console.error('Error:', error);
                });
            }

            function updateDurationValue() {
                if (!durationSlider || !durationValue) return;
                duration = parseInt(durationSlider.value);
                durationValue.textContent = duration + ' seconds';
            }

            function updateStartTimeValue() {
                if (!videoPreview || !startTimeSlider || !startTimeValue) return;

                // Calculate start time based on slider percentage and video duration
                if (videoPreview.duration) {
                    const percentage = parseInt(startTimeSlider.value) / 100;
                    const seconds = Math.floor(percentage * videoPreview.duration);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    startTimeValue.textContent = minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
                    
                    // Format for backend: HH:MM:SS
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    startTime = (hours < 10 ? '0' : '') + hours + ':' + 
                               (remainingMinutes < 10 ? '0' : '') + remainingMinutes + ':' + 
                               (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
                }
            }

            function initializeVideoControls() {
                if (!videoPreview || !startTimeSlider) return;

                originalVideoTime = videoPreview.currentTime;
                // Set max value for start time slider based on video duration
                // Leave 10 seconds at the end to ensure there's enough video for the minimum duration
                const maxPercentage = Math.max(0, (videoPreview.duration - 10) / videoPreview.duration * 100);
                startTimeSlider.max = Math.floor(maxPercentage);
                updateStartTimeValue();
            }

            function previewTrimmedClip() {
                if (!startTimeSlider || !videoPreview) return;

                // Get start time from slider
                const percentage = parseInt(startTimeSlider.value) / 100;
                const totalSeconds = Math.floor(percentage * videoPreview.duration);
                
                // Set video to start time
                videoPreview.currentTime = totalSeconds;
                
                // Play the video for the specified duration
                videoPreview.play();
                isTrimPreview = true;
                
                // Stop after the duration
                if (trimPreviewTimeout) {
                    clearTimeout(trimPreviewTimeout);
                }
                
                trimPreviewTimeout = setTimeout(() => {
                    videoPreview.pause();
                    isTrimPreview = false;
                }, duration * 1000);
            }

            function showDownloadOptions() {
                if (conversionStatus && downloadContainer) {
                    conversionStatus.classList.add('hidden');
                    downloadContainer.classList.remove('hidden');
                }
            }

            // preview feature removed: no modal or preview button present

            function downloadConvertedVideo() {
                if (convertedFileUrl) {
                    const link = document.createElement('a');
                    link.href = convertedFileUrl;
                    link.download = 'chromi_background.gif';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            function resetConverter() {
                // Reset all states
                currentFile = null;
                convertedFileUrl = null;
                
                if (videoPreview) videoPreview.src = '';
                if (fileName) fileName.textContent = '';
                if (fileInput) fileInput.value = '';
                
                if (startTimeSlider) startTimeSlider.value = 0;
                if (startTimeValue) startTimeValue.textContent = '0:00';
                if (durationSlider) durationSlider.value = 5;
                if (durationValue) durationValue.textContent = '5 seconds';
                
                startTime = "00:00:00";
                duration = 5;
                isTrimPreview = false;
                originalVideoTime = 0;
                
                if (trimPreviewTimeout) {
                    clearTimeout(trimPreviewTimeout);
                    trimPreviewTimeout = null;
                }
                
                // Show drop area, hide other containers
                if (dropArea) dropArea.classList.remove('hidden');
                if (videoPreviewContainer) videoPreviewContainer.classList.add('hidden');
                if (conversionStatus) conversionStatus.classList.add('hidden');
                if (downloadContainer) downloadContainer.classList.add('hidden');
                if (errorContainer) errorContainer.classList.add('hidden');
            }

            function showError(message) {
                if (errorMessage) errorMessage.textContent = message;
                if (videoPreviewContainer) videoPreviewContainer.classList.add('hidden');
                if (conversionStatus) conversionStatus.classList.add('hidden');
                if (downloadContainer) downloadContainer.classList.add('hidden');
                if (errorContainer) errorContainer.classList.remove('hidden');
            }
        });
    </script>
{% endblock %}